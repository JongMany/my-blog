# GitHub Pages ë°°í¬ ì›Œí¬í”Œë¡œìš° (ì„ íƒì  MFE ë¹Œë“œ)
# Micro Frontend ì•„í‚¤í…ì²˜ë¥¼ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì íŠ¸ì˜ ìµœì í™”ëœ ë°°í¬
name: Deploy to GitHub Pages (Selective MFE)

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  push:
    branches: [main] # main ë¸Œëœì¹˜ì— í‘¸ì‹œ ì‹œ ìë™ ì‹¤í–‰
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

# GitHub Pages ë°°í¬ì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read # ì €ì¥ì†Œ ë‚´ìš© ì½ê¸°
  pages: write # GitHub Pages ì“°ê¸°
  id-token: write # OIDC í† í° ìƒì„±
  actions: read # Actions ë©”íƒ€ë°ì´í„° ì½ê¸°

# ë™ì‹œ ì‹¤í–‰ ì œì–´ (ê°™ì€ ë¸Œëœì¹˜ì—ì„œ ì—¬ëŸ¬ ë°°í¬ê°€ ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë°©ì§€)
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ë©”ì¸ ë¹Œë“œ ë° ë°°í¬ ì‘ì—…
  build:
    runs-on: ubuntu-latest
    env:
      CI: true # CI í™˜ê²½ì„ì„ ëª…ì‹œ
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN || '' }} # Turbo ì›ê²© ìºì‹œ í† í°
      TURBO_TEAM: ${{ secrets.TURBO_TEAM  || ''}} # Turbo íŒ€ ì‹ë³„ì
      # MFE Apps configuration - ìƒˆ ì•± ì¶”ê°€ ì‹œ ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ë©´ ë¨
      MFE_APPS: "blog portfolio resume home"
    steps:
      # 1ï¸âƒ£ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ ë³€ê²½ëœ íŒŒì¼ ê°ì§€ (ì„ íƒì  ë¹Œë“œë¥¼ ìœ„í•œ ìµœì í™”)
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            # íŒ¨í‚¤ì§€/ì¸í”„ë¼ ë³€ê²½ ê°ì§€ (ì „ì²´ ë¹Œë“œ íŠ¸ë¦¬ê±°)
            packages:
              - 'packages/**'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'turbo.json'
              - 'scripts/**'
              - 'package.json'
              - '.github/workflows/**'
            # ì•± ë³€ê²½ ê°ì§€ (ì ì§„ì  ë¹Œë“œ ê°€ëŠ¥)
            apps:
              - 'apps/**'

      # 3ï¸âƒ£ PNPM ì„¤ì • (íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €)
      - uses: pnpm/action-setup@v4
        with: { run_install: false }

      # 4ï¸âƒ£ Node.js í™˜ê²½ ì„¤ì • ë° ì˜ì¡´ì„± ìºì‹±
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      # 5ï¸âƒ£ ì˜ì¡´ì„± ì„¤ì¹˜ (lock íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ ì •í™•í•œ ë²„ì „)
      - name: Install dependencies
        run: |
          # ì˜ì¡´ì„± ì„¤ì¹˜ (CI í™˜ê²½ì—ì„œëŠ” --no-frozen-lockfile ì‚¬ìš©)
          pnpm -w install --no-frozen-lockfile

      # 6ï¸âƒ£ ë¹Œë“œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ëŸ°íƒ€ì„ì— ì£¼ì…ë  ì •ë³´ë“¤)
      - name: Set build environment variables
        run: |
          echo "VITE_BUILD_ID=${{ github.sha }}" >> $GITHUB_ENV          # Git ì»¤ë°‹ í•´ì‹œ
          echo "VITE_BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV  # ë¹Œë“œ ì‹œê°„ (UTC)
          echo "VITE_BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV      # ë¸Œëœì¹˜ ì´ë¦„
          echo "VITE_GA_MEASUREMENT_ID=${{ secrets.VITE_GA_MEASUREMENT_ID }}" >> $GITHUB_ENV  # Google Analytics ì¸¡ì • ID
          echo "VITE_GA_API_URL=${{ secrets.VITE_GA_API_URL }}" >> $GITHUB_ENV  # Google Apps Script ì›¹ì•± URL

      # 7ï¸âƒ£ ë¸”ë¡œê·¸ ì½˜í…ì¸  ë¹Œë“œ (MDX â†’ ì •ì  íŒŒì¼ ë³€í™˜)
      - run: pnpm -w -F blog run content:build
      # 8ï¸âƒ£ ìŠ¤ë§ˆíŠ¸ ë¹Œë“œ ì „ëµ (ë³€ê²½ ì‚¬í•­ì— ë”°ë¥¸ ì„ íƒì  ë¹Œë“œ)

      # íŒ¨í‚¤ì§€/ì¸í”„ë¼ ë³€ê²½ ì‹œ: ì „ì²´ ë¹Œë“œ (ì•ˆì „í•œ ì ‘ê·¼)
      - name: Build all (packages/infra changed)
        if: steps.changes.outputs.packages == 'true'
        run: pnpm -w turbo run build

      # ì ì§„ì  ë¹Œë“œ: ì´ì „ ì»¤ë°‹ ì´í›„ ë³€ê²½ëœ ë¶€ë¶„ë§Œ (ì˜ì¡´ì„± í¬í•¨)
      - name: Build only changed since last commit (with deps)
        if: steps.changes.outputs.packages != 'true' && github.event.before != '' && github.event.before != github.sha
        run: pnpm -w turbo run build --filter="...[${{ github.event.before }}]"

      # í´ë°±: ë¹„êµ ê¸°ì¤€ì´ ì—†ëŠ” ê²½ìš° ì „ì²´ ë¹Œë“œ (ì´ˆê¸° í‘¸ì‹œ, force push ë“±)
      - name: Fallback full build if before empty or equal
        if: steps.changes.outputs.packages != 'true' && (github.event.before == '' || github.event.before == github.sha)
        run: pnpm -w turbo run build

      # 9ï¸âƒ£ ë³´ì¶© ë¹Œë“œ (ëˆ„ë½ëœ MFE ì•± ê°œë³„ ë¹Œë“œ)
      - name: Ensure all app dists exist
        run: |
          # Shell ì•± ë¹Œë“œ (ë©”ì¸ ì•±)
          if [ ! -d "apps/shell/dist" ]; then
            echo "ğŸ”§ Building shell app..."
            pnpm -w -F shell build:ghp
          else
            echo "âœ… shell app already built"
          fi

          # ê° MFE ì•±ì˜ ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸ í›„ ëˆ„ë½ëœ ê²ƒë§Œ ë¹Œë“œ
          for app in $MFE_APPS; do
            if [ ! -f "apps/${app}/dist/assets/remoteEntry.js" ]; then
              echo "ğŸ”§ Building missing ${app} app..."
              pnpm -w -F ${app} build:ghp
            else
              echo "âœ… ${app} app already built"
            fi
          done

      # ğŸ”Ÿ ë°°í¬ ì•„í‹°íŒ©íŠ¸ ìˆ˜ì§‘ ë° ê²€ì¦

      # GitHub Pages ë°°í¬ìš© ë””ë ‰í† ë¦¬ êµ¬ì„±
      - name: Collect deployment artifacts
        run: node scripts/collect-ghp.js

      # í•„ìˆ˜ íŒŒì¼ë“¤ì´ ì˜¬ë°”ë¥´ê²Œ ìƒì„±ë˜ì—ˆëŠ”ì§€ ê²€ì¦
      - name: Sanity check
        run: |
          echo "ğŸ” Checking required files..."

          # GitHub Pages í•„ìˆ˜ íŒŒì¼ í™•ì¸
          test -f dist_ghp/.nojekyll
          test -f dist_ghp/index.html

          # ëª¨ë“  MFE ì•±ì˜ ì§„ì…ì  í™•ì¸
          for app in $MFE_APPS; do
            # home ì•±ì€ shellê³¼ ê°™ì€ ê²½ë¡œì— ë°°ì¹˜ë˜ë¯€ë¡œ ê²½ë¡œê°€ ë‹¤ë¦„
            if [ "$app" = "home" ]; then
              if test -f "dist_ghp/assets/remoteEntry.js"; then
                echo "âœ… ${app}/assets/remoteEntry.js found (at dist_ghp/assets/remoteEntry.js)"
              else
                echo "âŒ Missing ${app}/assets/remoteEntry.js (expected at dist_ghp/assets/remoteEntry.js)"
                exit 1
              fi
            else
              if test -f "dist_ghp/${app}/assets/remoteEntry.js"; then
                echo "âœ… ${app}/assets/remoteEntry.js found"
              else
                echo "âŒ Missing ${app}/assets/remoteEntry.js"
                exit 1
              fi
            fi
          done

          echo "ğŸ‰ All required files are present!"

      # GitHub Pages ë°°í¬ìš© ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist_ghp

  # GitHub Pages ì‹¤ì œ ë°°í¬ ì‘ì—…
  deploy:
    needs: build # build ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ í›„ ì‹¤í–‰
    runs-on: ubuntu-latest
    environment:
      name: github-pages # GitHub Pages í™˜ê²½ ì‚¬ìš©
      url: ${{ steps.deployment.outputs.page_url }} # ë°°í¬ëœ ì‚¬ì´íŠ¸ URL
    steps:
      # ì—…ë¡œë“œëœ ì•„í‹°íŒ©íŠ¸ë¥¼ GitHub Pagesì— ë°°í¬
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
